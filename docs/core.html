---

title: cython_berry_core


keywords: fastai
sidebar: home_sidebar

summary: "Cython interface for the Berry inversion routine."
description: "Cython interface for the Berry inversion routine."
nb_path: "00_core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We start from this core routine in Python, which works for $J$ products on one market, with specification
$$
\bar{u}_j + X_{2j}\varepsilon_i + \xi_j + v_{ij}
$$
the idiosyncratic $v_{ij}$ is standard type-I EV and $\varepsilon_i$ is $N(0,\Sigma)$.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="npmaxabs" class="doc_header"><code>npmaxabs</code><a href="https://github.com/bsalanie/cython_berry_core/tree/masters/cython_berry_core/core.py#L11" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>npmaxabs</code>(<strong><code>arr</code></strong>:<code>ndarray</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="simulated_shares" class="doc_header"><code>simulated_shares</code><a href="https://github.com/bsalanie/cython_berry_core/tree/masters/cython_berry_core/core.py#L15" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>simulated_shares</code>(<strong><code>utils</code></strong>:<code>array</code>)</p>
</blockquote>
<p>return simulated shares for given simulated utilities</p>
<p>:param np.array utils: array <code>(nproducts, ndraws)</code></p>
<p>:return: simulated shares <code>(nproducts, ndraws)</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="simulated_mean_shares" class="doc_header"><code>simulated_mean_shares</code><a href="https://github.com/bsalanie/cython_berry_core/tree/masters/cython_berry_core/core.py#L29" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>simulated_mean_shares</code>(<strong><code>utils</code></strong>:<code>array</code>)</p>
</blockquote>
<p>return simulated mean shares for given simulated utilities</p>
<p>:param np.array utils: array <code>(nproducts, ndraws)</code></p>
<p>:return: np.array simulated mean shares: array <code>(nproducts)</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="berry_core" class="doc_header"><code>berry_core</code><a href="https://github.com/bsalanie/cython_berry_core/tree/masters/cython_berry_core/core.py#L39" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>berry_core</code>(<strong><code>shares</code></strong>:<code>array</code>, <strong><code>mean_u</code></strong>:<code>array</code>, <strong><code>X2</code></strong>:<code>array</code>, <strong><code>Sigma</code></strong>:<code>array</code>, <strong><code>tol</code></strong>:<code>float</code>=<em><code>1e-09</code></em>, <strong><code>maxiter</code></strong>:<code>int</code>=<em><code>10000</code></em>, <strong><code>ndraws</code></strong>:<code>int</code>=<em><code>10000</code></em>, <strong><code>verbose</code></strong>:<code>bool</code>=<em><code>False</code></em>)</p>
</blockquote>
<p>contraction to invert for product effects :math:<code>\xi</code> from market shares</p>
<p>:param np.array shares: <code>nproducts</code> vector of observed market shares</p>
<p>:param np.array mean_u: <code>(nproducts)</code> vector of mean utilities</p>
<p>:param np.array X2: <code>(nproducts, nx2)</code> matrix of nonlinear covariates</p>
<p>:param np.array Sigma: <code>(nx2, nx2)</code> variance-covariance matrix of random coefficients on <code>X2</code>,     or <code>(nx2)</code> if diagonal</p>
<p>:param float tol: tolerance</p>
<p>:param int maxiter: max iterations</p>
<p>:param int ndraws: number of draws for simulation</p>
<p>:params bool verbose: print stuff if <code>True</code></p>
<p>:return: <code>(nproducts)</code> vector of :math:<code>\xi</code> values, and return code 0 if OK</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="k">as</span> <span class="nn">npla</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>

<span class="k">def</span> <span class="nf">npmaxabs</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">simulated_shares</span><span class="p">(</span><span class="n">utils</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    return simulated shares for given simulated utilities</span>

<span class="sd">    :param np.array utils: array `(nproducts, ndraws)`</span>

<span class="sd">    :return: simulated shares `(nproducts, ndraws)`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shares</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">utils</span><span class="p">)</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">shares</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">shares</span> <span class="o">=</span> <span class="n">shares</span> <span class="o">/</span> <span class="n">denom</span>
    <span class="k">return</span> <span class="n">shares</span>


<span class="k">def</span> <span class="nf">simulated_mean_shares</span><span class="p">(</span><span class="n">utils</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    return simulated mean shares for given simulated utilities</span>

<span class="sd">    :param np.array utils: array `(nproducts, ndraws)`</span>

<span class="sd">    :return: np.array simulated mean shares: array `(nproducts)`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">simulated_shares</span><span class="p">(</span><span class="n">utils</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">berry_core</span><span class="p">(</span><span class="n">shares</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">mean_u</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">X2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
               <span class="n">Sigma</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-9</span><span class="p">,</span>
               <span class="n">maxiter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">ndraws</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    contraction to invert for product effects :math:`\\xi` from market shares</span>

<span class="sd">    :param np.array shares: `nproducts` vector of observed market shares</span>

<span class="sd">    :param np.array mean_u: `(nproducts)` vector of mean utilities</span>

<span class="sd">    :param np.array X2: `(nproducts, nx2)` matrix of nonlinear covariates</span>

<span class="sd">    :param np.array Sigma: `(nx2, nx2)` variance-covariance matrix of random coefficients on `X2`, \</span>
<span class="sd">    or `(nx2)` if diagonal</span>

<span class="sd">    :param float tol: tolerance</span>

<span class="sd">    :param int maxiter: max iterations</span>

<span class="sd">    :param int ndraws: number of draws for simulation</span>

<span class="sd">    :params bool verbose: print stuff if `True`</span>

<span class="sd">    :return: `(nproducts)` vector of :math:`\\xi` values, and return code 0 if OK</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nproducts</span><span class="p">,</span> <span class="n">nx2</span> <span class="o">=</span> <span class="n">X2</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">assert</span> <span class="n">shares</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">nproducts</span><span class="p">,</span> <span class="s2">&quot;should have as many shares as rows in X2&quot;</span>
    <span class="k">assert</span> <span class="n">mean_u</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">nproducts</span><span class="p">,</span> <span class="s2">&quot;should have as many mean utilities as rows in X2&quot;</span>

    <span class="k">if</span> <span class="n">Sigma</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">Sigma</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">nx2</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Sigma</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;berry_core: all elements of the diagonal Sigma should be positive or 0&quot;</span>
        <span class="n">Xsig</span> <span class="o">=</span> <span class="n">X2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Sigma</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">Sigma</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">Sigma</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">nx2</span><span class="p">,</span> <span class="n">nx2</span><span class="p">):</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">npla</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">Sigma</span><span class="p">)</span>
        <span class="n">Xsig</span> <span class="o">=</span> <span class="n">X2</span> <span class="o">@</span> <span class="n">L</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">print_stars</span><span class="p">(</span><span class="s2">&quot;berry_core: Sigma should be (nx2, nx2) or (nx2)&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="n">sum_shares</span> <span class="o">=</span> <span class="n">shares</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">market_zero_share</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">sum_shares</span>

    <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">shares</span> <span class="o">/</span> <span class="n">market_zero_share</span><span class="p">)</span> <span class="o">-</span> <span class="n">mean_u</span>
    <span class="n">max_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
    <span class="n">retcode</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">nx2</span><span class="p">,</span> <span class="n">ndraws</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">max_err</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
        <span class="n">utils</span> <span class="o">=</span> <span class="p">(</span><span class="n">Xsig</span> <span class="o">@</span> <span class="n">eps</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">mean_u</span> <span class="o">+</span> <span class="n">xi</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">shares_sim</span> <span class="o">=</span> <span class="n">simulated_mean_shares</span><span class="p">(</span><span class="n">utils</span><span class="p">)</span>
        <span class="n">err_shares</span> <span class="o">=</span> <span class="n">shares</span> <span class="o">-</span> <span class="n">shares_sim</span>
        <span class="n">max_err</span> <span class="o">=</span> <span class="n">npmaxabs</span><span class="p">(</span><span class="n">err_shares</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;berry_core: error </span><span class="si">{</span><span class="n">max_err</span><span class="si">}</span><span class="s2"> after </span><span class="si">{</span><span class="nb">iter</span><span class="si">}</span><span class="s2"> iterations&quot;</span><span class="p">)</span>
        <span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="n">maxiter</span><span class="p">:</span>
            <span class="n">retcode</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">break</span>
        <span class="n">xi</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">shares</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">shares_sim</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">print_stars</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;berry_core: error </span><span class="si">{</span><span class="n">max_err</span><span class="si">}</span><span class="s2"> after </span><span class="si">{</span><span class="nb">iter</span><span class="si">}</span><span class="s2"> iterations&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xi</span><span class="p">,</span> <span class="n">retcode</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Try an example:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">nproducts</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">shares</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
<span class="n">mean_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
<span class="n">X2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>
<span class="n">Sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>

<span class="n">xi</span><span class="p">,</span> <span class="n">retcode</span> <span class="o">=</span> <span class="n">berry_core</span><span class="p">(</span><span class="n">shares</span><span class="p">,</span> <span class="n">mean_u</span><span class="p">,</span> <span class="n">X2</span><span class="p">,</span> <span class="n">Sigma</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;retcode = </span><span class="si">{</span><span class="n">retcode</span><span class="si">}</span><span class="s2">; xi is:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>

<span class="c1"># checking</span>
<span class="n">L</span> <span class="o">=</span> <span class="n">npla</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">Sigma</span><span class="p">)</span>
<span class="n">Xsig</span> <span class="o">=</span> <span class="n">X2</span> <span class="o">@</span> <span class="n">L</span>
<span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span>
<span class="n">utils</span> <span class="o">=</span> <span class="p">(</span><span class="n">Xsig</span> <span class="o">@</span> <span class="n">eps</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">mean_u</span> <span class="o">+</span> <span class="n">xi</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">sim_shares</span> <span class="o">=</span> <span class="n">simulated_mean_shares</span><span class="p">(</span><span class="n">utils</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Observed and simulated mean shares:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">shares</span><span class="p">,</span> <span class="n">sim_shares</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>retcode = 0; xi is:
[ 1.69856261 -1.96799988 -1.29408955]

Observed and simulated mean shares:
[[0.4        0.40248714]
 [0.2        0.19773723]
 [0.3        0.29989099]]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.export</span> <span class="kn">import</span> <span class="n">notebook2script</span><span class="p">;</span> <span class="n">notebook2script</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Converted 00_core.ipynb.
Converted index.ipynb.
Converted kite_tutorial.ipynb.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

